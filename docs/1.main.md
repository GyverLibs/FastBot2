## Документация FastBot2
Библиотека может показаться сложной в использовании, как минимум гораздо сложнее FastBot первой версии =) Но это не просто так: FastBot2 позволяет использовать все возможности Телеграм и написать бота почти любой сложности, а также имеет очень удобные инструменты для обработки текстовых данных от юзеров. Для разработки рекомендуется использовать "взрослую" среду разработки типа VS Code (+Platformio), подсказки методов классов практически полностью заменят вам данную документацию.

На этой странице находится полный перечень всех классов и их методов.

### Лимиты Telegram
Телеграм устанавливает следующие ([лимиты](https://core.telegram.org/bots/faq#my-bot-is-hitting-limits-how-do-i-avoid-this)) на взаимодействие с ботом:

#### Отправка
- В личный чат: не чаще раза в секунду. *Отправлять чаще можно, но сообщение может не дойти*
- В группу: не чаще 20 сообщений в минуту
- Суммарный лимит: не чаще 30 сообщений в секунду
- Бот не может писать в личку другому боту

#### Чтение
- Бот может читать и взаимодействовать с сообщениями (изменять, удалять), с момента отправки которых прошло **не больше 24 часов**
- Бот [не видит](https://core.telegram.org/bots/faq#why-doesn-39t-my-bot-see-messages-from-other-bots) сообщения от других ботов в группе
- Телеграм разделяет текст на несколько сообщений, если длина текста превышает ~4000 символов. Эти сообщения будут иметь разный messageID в чате

### Настройка бота
- Если бот у вас уже есть, убедитесь что он не в webhook режиме (отключен по умолчанию), иначе esp не сможет принимать сообщения
- Для того, чтобы бот читал все сообщения в группе (а не только /команды), нужно отключить параметр Group Privacy в настройках бота Bot Settings в чате с @BotFather. Данный параметр включен по умолчанию
- Для полноценной работы в группе (супергруппе) бота нужно сделать администратором

### Настройки компиляции
Объявляются перед подключением библиотеки
```cpp
#define FB_NO_FILE  // убрать поддержку работы с файлами
```

### Класс бота
<details>
<summary>VirtualFastBot2</summary>

Остальные классы бота наследуют его!
```cpp
// ============================== SYSTEM ==============================
// разрешение и запрет типов обновлений
fb::Updates updates;

// установить токен
void setToken(const String& token);

// получить токен
const String& getToken();

// установить лимит - кол-во сообщений в одном обновлении (умолч. 3)
void setLimit(uint8_t limit = 3);

// установить режим и период опроса (умолч. Poll::Sync и 4000 мс)
void setPollMode(fb::Poll mode = fb::Poll::Sync, uint16_t period = 4000);

// получить режим опроса
fb::Poll getPollMode();

// установить таймаут ожидания ответа сервера (умолч. 3000 мс)
void setTimeout(uint16_t timeout);

// запустить (по умолчанию уже запущен)
void begin();

// остановить
void end();

// пропустить непрочитанные сообщения. Вызывать однократно https://core.telegram.org/bots/api#getupdates
void skipUpdates(int32_t offset = -1);

// пропустить следующее сообщение (сдвинуть оффсет на 1)
void skipNextMessage();

// id последнего отправленного сообщения от бота
uint32_t lastBotMessage();

// хэш последней отправленной ботом команды
size_t lastCmd();

// ============================== ATTACH ==============================

// подключить обработчик обновлений вида void cb(fb::Update& u) {}
void attachUpdate(CallbackUpdate callback);

// отключить обработчик обновлений
void detachUpdate();

// подключить обработчик результата вида void cb(gson::Entry& r) {}
// здесь нельзя отправлять сообщения с флагом wait
void attachResult(CallbackResult callback);

// отключить обработчик результата
void detachResult();

// подключить обработчик сырых json данных Telegram вида void cb(const String& r) {}
void attachRaw(CallbackRaw callback);

// отключить обработчик сырых данных
void detachRaw();

// подключить обработчик скачивания файлов вида void cb(Stream& stream, size_t length) {}
void attachFetch(CallbackFetch callback);

// отключить обработчик скачивания файлов
void detachFetch();

// ============================== TICK ==============================

// тикер, вызывать в loop
bool tick();

// система ждёт ответа с обновлениями
bool isPolling();

// отправить запрос на обновление
bool getUpdates(bool wait = false);

// запросить перезагрузку устройства
void reboot();

// можно перезагрузить устройство
bool canReboot();

// ============================== SEND ==============================

// ответить на callback. Можно указать текст и вызвать alert
bool answerCallbackQuery(const su::Text& id, su::Text text = su::Text(), bool show_alert = false, bool wait = false);

// переслать сообщение
bool forwardMessage(const fb::MessageForward& m, bool wait = false);

// отправить сообщение
bool sendMessage(const fb::Message& m, bool wait = false);

// отправить геолокацию
bool sendLocation(const fb::Location& m, bool wait = false);

// ============================== FILE ==============================

// отправить файл, тип указывается в fb::File
bool sendFile(const fb::File& m, bool wait = false);

// редактировать файл
bool editFile(const fb::FileEdit& m, bool wait = false);

// запросить файл (придёт в обработчик attachFetch)
bool getFile(const su::Text& fileID, bool wait = false);

// скачать файл
fb::Fetcher downloadFile(const su::Text& fileID);

// ============================== SET ==============================

// отправить статус "набирает сообщение" на 5 секунд
bool setTyping(su::Value chatID, bool wait = false);

// установить заголовок чата
bool setChatTitle(su::Value chatID, su::Text title, bool wait = false);

// установить описание чата
bool setChatDescription(su::Value chatID, su::Text description, bool wait = false);

// установить подсказки команд бота
bool setMyCommands(const fb::MyCommands& commands, bool wait = false);

// удалить подсказки команд бота
bool deleteMyCommands(bool wait = false);

// установить имя бота
bool setMyName(const su::Text& name, bool wait = false);

// установить описание бота
bool setMyDescription(const su::Text& description, bool wait = false);

// ============================== PIN ==============================

// закрепить сообщение
bool pinChatMessage(su::Value chatID, su::Value messageID, bool notify = true, bool wait = false);

// открепить сообщение
bool unpinChatMessage(su::Value chatID, su::Value messageID, bool wait = false);

// открепить все сообщения
bool unpinAllChatMessages(su::Value chatID, bool wait = false);

// ============================== EDIT ==============================

// редактировать текст
bool editText(const fb::TextEdit& m, bool wait = false);

// редактировать заголовок
bool editCaption(const fb::CaptionEdit& m, bool wait = false);

// редактировать меню
bool editMenu(const fb::MenuEdit& m, bool wait = false);

// редактировать геолокацию
bool editLocation(const fb::LocationEdit& m, bool wait = false);

// остановить геолокацию
bool stopLocation(const fb::LocationStop& m, bool wait = false);

// ============================== DELETE ==============================

// удалить сообщение
bool deleteMessage(su::Value chatID, su::Value messageID, bool wait = false);

// удалить сообщения
bool deleteMessages(su::Value chatID, uint32_t* messageIDs, uint16_t amount, bool wait = false);

// ============================== MANUAL ==============================

// начать пакет для ручной отправки в API
fb::Packet beginPacket(const __FlashStringHelper* cmd);

// отправить пакет
bool sendPacket(fb::Packet& packet, bool wait = false);

// принять файл в коллбэк
void handleFile(Stream& stream);

// парсить json ответ сервера
bool parsePacket(const su::Text& s, bool useYield = true);
```
</details>
<details>
<summary>FastBot2Client</summary>

```cpp
FastBot2Client(Client& client);

// установить таймаут ожидания ответа сервера (умолч. 2000 мс)
void setTimeout(uint16_t timeout);

// установить лимит памяти на ответ сервера (библиотека начнёт пропускать сообщения), умолч. 20000
void setMemLimit(uint16_t limit);

AsyncHTTP http;
```
</details>
<details>
<summary>FastBot2</summary>

```cpp
FastBot2();
```
</details>

### Чтение
<details>
<summary>fb::Update</summary>

```cpp
// fb::Update::Type
Message
EditedMessage
ChannelPost
EditedChannelPost
BusinessConnection
BusinessMessage
EditedBusinessMessage
DeletedBusinessMessages
MessageReaction
MessageReactionCount
InlineQuery
ChosenInlineResult
CallbackQuery
ShippingQuery
PreCheckoutQuery
Poll
PollAnswer
MyChatMember
ChatMember
ChatJoinRequest
ChatBoost
RemovedChatBoost
```
```cpp
// тип апдейта
Type type();

// ================ QUERY ================

// это query
bool isQuery();

// query
QueryRead query();

// ================ MESSAGE ================

// сообщение
MessageRead message();

// это сообщение
bool isMessage();

// это пост в канале
bool isPost();

// это отредактированное сообщение или отредактированный пост
bool isEdited();
```
</details>
<details>
<summary>fb::MessageRead</summary>

```cpp
// ================ INFO ================

// текст сообщения
su::Text text();

// id сообщения в этом чате
su::Text id();

// id темы в группе
su::Text threadID();

// сообщение отправлено в топик форума
su::Text isTopic();

// дата отправки или пересылки сообщения
su::Text date();

// дата изменения сообщения
su::Text editDate();

// ================ SENDER ================

// отправитель сообщения
UserRead from();

// бот, через которого пришло это сообщение
UserRead viaBot();

// чат, которому принадлежит это сообщение
ChatRead chat();

// чат, если сообщение отправлено от имени чата
ChatRead senderChat();

// ================ REPLY ================

// сообщение является ответом на сообщение
bool isReply();

// сообщение, на которое отвечает это сообщение
MessageRead reply();

// ================ FORWARD ================

// сообщение переслано из другого чата
bool isForward();

// данные о пересланном сообщении
MessageOriginRead forward();

// ================ LOCATION ================

// сообщение содержит геолокацию
bool hasLocation();

// геолокация
LocationRead location();

// ================ DOCUMENT ================

// сообщение содержит документ
bool hasDocument();

// документ
DocumentRead document();
```
</details>
<details>
<summary>fb::MessageOriginRead</summary>

```cpp
// fb::MessageOriginRead::Type
user
hiddenUser
chat
channel
```
```cpp
// тип отправителя: user, hidden_user, chat, channel
Type type();

// дата оригинального сообщения
su::Text date();

// отправитель type == user
UserRead senderUser();

// отправитель type == chat
ChatRead senderChat();

// отправитель type == channel
ChatRead chat();
```
</details>
<details>
<summary>fb::Fetcher</summary>

```cpp
// напечатать в принт
template <typename T>
bool writeTo(T& p);

// обновить прошивку (ESP)
bool updateFlash();

// обновить файловую систему (ESP)
bool updateFS();

// есть данные для чтения
int available();

// есть данные для чтения
operator bool();

Stream* stream;
```
</details>
<details>
<summary>fb::ChatRead</summary>

```cpp
// fb::ChatRead::Type
privateChat
group
supergroup
channel
```
```cpp
// id чата
su::Text id();

// тип чата: private_chat, group, supergroup, channel
Type type();

// название чата (для supergroups, channels, group chats)
su::Text title();

// имя чата (для private chats, supergroups, channels)
su::Text username();

// имя (для private chat)
su::Text firstName();

// фамилия (для private chat)
su::Text lastName();

// описание чата
su::Text description();

// в supergroup включены темы
su::Text isForum();
```
</details>
<details>
<summary>fb::DocumentRead</summary>

```cpp
// id документа, можно использовать для скачивания
su::Text id();

// уникальный id документа в системе
su::Text uniqueID();

// имя документа
su::Text name();

// MIME тип документа
su::Text type();

// размер документа
su::Text size();
```
</details>
<details>
<summary>fb::LocationRead</summary>

```cpp
// широта
su::Text latitude();

// долгота
su::Text longitude();

// точность в метрах, 0-1500
su::Text horizontalAccuracy();

// Время относительно даты отправки сообщения в секундах, в течение которого местоположение может быть обновлено
su::Text livePeriod();

// направление в градусах, 1-360
su::Text heading();

// Максимальное расстояние в метрах для оповещений о приближении к другому участнику чата
su::Text proximityAlertRadius();
```
</details>
<details>
<summary>fb::UserRead</summary>

```cpp
// id юзера
su::Text id();

// бот или нет
su::Text isBot();

// имя
su::Text firstName();

// фамилия
su::Text lastName();

// юзернейм
su::Text username();

// код страны https://en.wikipedia.org/wiki/IETF_language_tag
su::Text languageCode();

// true - премиум юзер
su::Text isPremium();
```
</details>
<details>
<summary>fb::QueryRead</summary>

```cpp
// callback id
su::Text id();

// callback data
su::Text data();

// отправитель коллбэка
UserRead from();

// сообщение
MessageRead message();
```
</details>

### Отправка
<details>
<summary>fb::Message</summary>

```cpp
// fb::Message::Mode
Text
MarkdownV2
HTML
```
```cpp
Message() {}
Message(const String& text, const su::Value& chatID);

// текст сообщения
String text;

// id чата, куда отправлять
su::Value chatID;

// id темы в группе, куда отправлять
int32_t threadID = -1;

// параметры ответа на сообщение
ReplyParam reply;

// включить превью для ссылок
bool preview = previewDefault;

// уведомить о получении
bool notification = notificationDefault;

// защитить от пересылки и копирования
bool protect = protectDefault;

// режим текста: Text, MarkdownV2, HTML
Mode mode = modeDefault;

// добавить обычное меню
void setMenu(Menu& menu);

// добавить инлайн меню
void setInlineMenu(InlineMenu& menu);

// удалить обычное меню
void removeMenu();

// ===================================

// включить превью для ссылок (умолч. 1)
static bool previewDefault;

// уведомить о получении (умолч. 1)
static bool notificationDefault;

// защитить от пересылки и копирования (умолч. 0)
static bool protectDefault;

// режим текста: Text, MarkdownV2, HTML (умолч. Text)
static Mode modeDefault;
```
</details>
<details>
<summary>fb::ReplyParam</summary>

```cpp
// id сообщения, на которое отвечаем
int32_t messageID = -1;

// id чата, в котором находится сообщение, на которое отвечаем
su::Value chatID;
```
</details>

<details>
<summary>fb::MessageForward</summary>

```cpp
MessageForward() {}
MessageForward(uint32_t messageID, const su::Value& fromChatID, const su::Value& chatID);

// id пересылаемого сообщения в чате
uint32_t messageID;

// id чата пересылаемого сообщения
su::Value fromChatID;

// id чата, в который пересылать
su::Value chatID;

// id темы в группе, в которую переслать
int32_t threadID = -1;

// уведомить о получении
bool notification = Message::notificationDefault;

// защитить от пересылки и копирования
bool protect = Message::protectDefault;
```
</details>
<details>
<summary>fb::MyCommands</summary>

```cpp
MyCommands();
MyCommands(const String& commands, const String& description);

// список команд, длина команды 1-32, разделитель ;
String commands = "";

// список описаний команд, длина описания 1-256, разделитель ;
String description = "";

// зарезервировать строки
void reserve(uint16_t len);

// добавить команду
void addCommand(const String& command, const String& description);
```
</details>
<details>
<summary>fb::File</summary>

```cpp
// fb::File::type
photo
audio
document
video
animation
voice
video_note
```
```cpp
// отправить fs::File файл
File(const su::Text& name, Type type, ::File& file) : File(name, type, file, false);

// отправить данные из byte буфера
File(const su::Text& name, Type type, uint8_t* bytes, size_t length);

// отправить по ID файла в телеге или ссылкой (для document только GIF, PDF и ZIP)
// https://core.telegram.org/bots/api#sending-files
File(const su::Text& name, Type type, const su::Text& urlid) : File(name, type, urlid, false);

using Message::chatID;
using Message::mode;
using Message::notification;
using Message::protect;
using Message::reply;
using Message::setInlineMenu;
using Message::threadID;

// заголовок
String caption;
```
</details>
<details>
<summary>fb::Menu</summary>

```cpp
Menu() {}
Menu(const String& text) : text(text) {}

// надписи кнопок. Гор. разделитель - ;, верт. - \n (кнопка_1 ; кнопка_2 \n кнопка_3 ; кнопка_4)
String text = "";

// подсказка, показывается в поле ввода при открытой клавиатуре (до 64 символов)
String placeholder = "";

// принудительно показывать клавиатуру
bool persistent = persistentDefault;

// уменьшить клавиатуру под количество кнопок
bool resize = resizeDefault;

// автоматически скрывать после нажатия
bool oneTime = oneTimeDefault;

// показывать только упомянутым в сообщении юзерам
bool selective = selectiveDefault;

// добавить кнопку
Menu& addButton(su::Text text);

// перенести строку
Menu& newRow();

// ===================================

// принудительно показывать клавиатуру (умолч. 0)
static bool persistentDefault;

// уменьшить клавиатуру под количество кнопок (умолч. 0)
static bool resizeDefault;

// автоматически скрывать после нажатия (умолч. 0)
static bool oneTimeDefault;

// показывать только упомянутым в сообщении юзерам (умолч. 0)
static bool selectiveDefault;
```
</details>
<details>
<summary>fb::InlineMenu</summary>

```cpp
InlineMenu();
InlineMenu(const String& text, const String& data);
InlineMenu(uint16_t reserve);

// надписи кнопок. Гор. разделитель - ;, верт. - \n (кнопка_1 ; кнопка_2 \n кнопка_3 ; кнопка_4)
String text = "";

// callback data кнопок с разделителем ; . Поддерживаются url адреса
String data = "";

// зарезервировать строки
void reserve(uint16_t len);

// добавить кнопку
InlineMenu& addButton(su::Text text, su::Text data = su::Text());

// перенести строку
InlineMenu& newRow();
```
</details>
<details>
<summary>fb::Location</summary>

```cpp
Location();
Location(float latitude, float longitude, const su::Value& chatID);

using Message::chatID;
using Message::notification;
using Message::protect;
using Message::removeMenu;
using Message::reply;
using Message::setInlineMenu;
using Message::setMenu;
using Message::threadID;

// широта
float latitude;

// долгота
float longitude;

// точность в метрах, 0-1500
float horizontalAccuracy = NAN;

// период обновления локации в секундах 60.. 86400
uint32_t livePeriod = 0;

// направление в градусах, 1-360
uint16_t heading = 0;

// Максимальное расстояние в метрах для оповещений о приближении к другому участнику чата
uint32_t proximityAlertRadius = 0;
```
</details>

### Редактирование
<details>
<summary>fb::FileEdit</summary>

```cpp
FileEdit(const su::Text& name, Type type, ::File& file);
FileEdit(const su::Text& name, Type type, uint8_t* bytes, size_t length);

// document by url - GIF, PDF and ZIP
// https://core.telegram.org/bots/api#sending-files
FileEdit(const su::Text& name, Type type, const su::Text& urlid);

// id сообщения
uint32_t messageID;

using File::caption;
using File::chatID;
using File::multipart;
using Message::setInlineMenu;
```
</details>
<details>
<summary>fb::TextEdit</summary>

```cpp
TextEdit();
TextEdit(const String& text, uint32_t messageID, const su::Value& chatID);

// id сообщения
uint32_t messageID;

using Message::chatID;
using Message::mode;
using Message::preview;
using Message::setInlineMenu;
using Message::text;
```
</details>
<details>
<summary>fb::MenuEdit</summary>

```cpp
MenuEdit();
MenuEdit(uint32_t messageID, const su::Value& chatID);
MenuEdit(uint32_t messageID, const su::Value& chatID, InlineMenu& menu);

// id сообщения
uint32_t messageID;

using Message::chatID;
using Message::setInlineMenu;
```
</details>
<details>
<summary>fb::CaptionEdit</summary>

```cpp
CaptionEdit();
CaptionEdit(const String& caption, uint32_t messageID, const su::Value& chatID);

// заголовок
String caption;

// id сообщения
uint32_t messageID;

using Message::chatID;
using Message::mode;
using Message::setInlineMenu;
```
</details>
<details>
<summary>fb::LocationEdit</summary>

```cpp
LocationEdit();
LocationEdit(float latitude, float longitude, uint32_t messageID, const su::Value& chatID);

// широта
float latitude;

// долгота
float longitude;

// id сообщения
uint32_t messageID;

// точность в метрах, 0-1500
float horizontalAccuracy = NAN;

// направление в градусах, 1-360
uint16_t heading = 0;

// Максимальное расстояние в метрах для оповещений о приближении к другому участнику чата
uint32_t proximityAlertRadius = 0;

using Message::chatID;
using Message::setInlineMenu;
```
</details>
<details>
<summary>fb::LocationStop</summary>

```cpp
LocationStop();
LocationStop(uint32_t messageID, const su::Value& chatID);

// id сообщения
uint32_t messageID;

using Message::chatID;
using Message::setInlineMenu;
```
</details>

### Прочее
<details>
<summary>fb::Poll</summary>

```cpp
Sync   // синхронный (рекомендуемый период > 3500 мс)
Async  // асинхронный (рекомендуемый период > 3500 мс)
Long   // асинхронный long polling (рекомендуемый период > 20000 мс)
```
</details>
<details>
<summary>fb::Updates</summary>

```cpp
// fb::Updates::Type
Message
EditedMessage
ChannelPost
EditedChannelPost
BusinessConnection
BusinessMessage
EditedBusinessMessage
DeletedBusinessMessages
MessageReaction
MessageReactionCount
InlineQuery
ChosenInlineResult
CallbackQuery
ShippingQuery
PreCheckoutQuery
Poll
PollAnswer
MyChatMember
ChatMember
ChatJoinRequest
ChatBoost
RemovedChatBoost
```
```cpp
// установить
void set(uint32_t nmods);

// очистить
void clear(uint32_t nmods);

// включить все
void setAll();

// очистить все
void clearAll();

// прочитать по типу
bool read(Type m);

// прочитать по индексу
bool read(uint8_t idx);
```
</details>